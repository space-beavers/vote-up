<link rel="import" href="shared-styles.html">
<link rel="import" href="vu-behavior.html">
<link rel="import" href="vu-editor.html">


<dom-module id="vu-space">
  <template>
    <style include="vote-up-app-shared-styles"></style>

    <firebase-document
        id="document"
        app-name="vote-up"
        path="spaces/[[currentSpaceId]]/topics/[[editableTopicId]]"
        data="{{editableTopic}}">
    </firebase-document>

    <vu-editor
        id="editor"
        topic="{{editableTopic}}"
        on-close="commitChange">
    </vu-editor>

    <div class="topics">
      <template is="dom-repeat" items="[[topics]]" as="topic">
      <vu-topic
          id="[[topic.name]]"
          title="[[topic.value.title]]"
          description="[[topic.value.description]]"
          tags="[[topic.value.tags]]"
          vote-count="[[topicVoteCount(topic.name)]]"
          voted="[[hasCurrentUserVotedOnTopic(topic.name)]]"
          current-space="{{currentSpace}}"
          current-user-id="[[user.uid]]"
          created-by="[[topic.value.createdBy]]"
          on-tap="edit">
      </vu-topic>
      </template>
    </div>
  </template>
  <script>
    Polymer({
      is: 'vu-space',

      behaviors: [
        MyBehaviors.VoteUpAppBehavior
      ],

      observers: [
        '_onCurrentSpaceChange(currentSpace)'
      ],

      listeners: {
        'topic-vote-up': 'onVoteUp',
        'topic-vote-cancel': 'onVoteCancel'
      },

      properties: {
        currentSpace: {
          type: Object
        },

        name: {
          type: String
        },

        topicsVote: {
          type: Array
        },

        topics: {
          type: Array
        },

        user: {
          type: Object
        }
      },

      _onCurrentSpaceChange: function(currentSpace, previousSpace){
        if(Object.keys(currentSpace).length !== 0){
          this.name = currentSpace.name;
          this.topicsVote = currentSpace.topicVotes;
          this.topics = this.firebaseObjectToArray(currentSpace.topics);
        }
      },

      topicVoteCount: function(topicId){
        return (this.topicsVote && this.topicsVote[topicId]) ? this.topicsVote[topicId].length : 0;
      },

      hasCurrentUserVotedOnTopic: function (topicId){
        let hasCurrentUserVoted = false;

        if (this.topicsVote && this.topicsVote[topicId]) {

          this.topicsVote[topicId].map(vote => {

            if(vote.createdBy === this.user.uid){
              hasCurrentUserVoted = true;
            }
          }, this);
        }
        return hasCurrentUserVoted;
      },

      onVoteUp: function(e) {
        let topicId = e.srcElement.id;
        let vote = {
          createdBy: this.user.uid,
          createdTime: new Date(),
          value: 1
        };

        // If first vote on space
        if (!this.currentSpace.topicVotes) this.currentSpace.topicVotes = {};

        let votes = this.currentSpace.topicVotes;

        // If first vote on topic, initialize a key with topic id
        if (!votes[topicId]) votes[topicId] = [];

        votes[topicId].push(vote);
        this.notifyPath('currentSpace.topicVotes.' + topicId);
      },

      onVoteCancel: function(e) {
        let topicId = e.srcElement.id;
        let votes = this.currentSpace.topicVotes;
        let voteToCancelIndex;

        for (let i = 0; i < votes[topicId].length; i++) {
          if(votes[topicId][i].createdBy === this.currentUserId){
            let voteToCancelIndex = i;
          }
        }

        votes[topicId].splice(voteToCancelIndex,1);
        this.notifyPath('currentSpace.topicVotes.' + topicId);
      }
    })
  </script>
</dom-module>
