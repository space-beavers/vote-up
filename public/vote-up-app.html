<link rel="import" href="elements/vu-elements.html">
<link rel="import" href="bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="bower_components/polymerfire/polymerfire.html">

<dom-module id="vote-up-app">
  <template>
    <style include="vote-up-app-shared-styles"></style>

    <!--<paper-drawer-panel id="drawerPanel">-->
      <!--<paper-header-panel drawer>-->
        <!--<div>-->
          <!--<paper-menu id="pageSelector" selected="allTopics" attr-for-selected="value" on-iron-select="switchPage">-->
            <!--<paper-item value="allTopics">Topic Roadmap</paper-item>-->
            <!--<paper-item value="myTopics">My Topics</paper-item>-->
          <!--</paper-menu>-->
        <!--</div>-->
      <!--</paper-header-panel>-->

      <div main>
        <vu-toolbar
          signed-in="[[signedIn]]"
          on-sign-out="signOut">
        </vu-toolbar>

        <paper-tabs id="pageSelector" selected="allTopics" attr-for-selected="value" on-iron-select="switchPage">
          <paper-tab value="allTopics">Topic Roadmap</paper-tab>
          <paper-tab value="myTopics">My Topics</paper-tab>
          <paper-tab value="history">History</paper-tab>
        </paper-tabs>

        <paper-dropdown-menu id="spaceDropdown" on-iron-select="_spaceDropdownObserver" label="Spaces">
          <paper-listbox class="dropdown-content" selected="0">
            <template is="dom-repeat" items="[[spaces]]" as="space">
              <paper-item id$="[[space.$key]]">
                [[space.name]]
              </paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>

        <vu-login
            on-sign-in="signIn"
            signed-in="[[signedIn]]"
            disabled="[[!online]]">
        </vu-login>

        <firebase-auth
            id="auth"
            app-name="vote-up"
            provider="google"
            signed-in="{{signedIn}}"
            user="{{user}}">
        </firebase-auth>

        <firebase-document
            id="currentSpace"
            app-name="vote-up"
            path="/spaces/{{currentSpaceId}}"
            data="{{currentSpace}}">
        </firebase-document>

        <firebase-query
            id="spacesQuery"
            app-name="vote-up"
            path="/spaces"
            data="{{spaces}}">
        </firebase-query>

        <!-- <app-indexeddb-mirror
            session="[[user.uid]]"
            key="topics"
            data="{{allTopics}}"
            persisted-data="{{persistedTopics}}">
        </app-indexeddb-mirror> -->

        <vu-space topics="[[topics]]" user="{{user}}" current-space="{{currentSpace}}"></vu-space>
        <paper-fab icon="add" on-tap="create" aria-label="Add topic" hidden$="[[!online]]"></paper-fab>
      </div>
    <!--</paper-drawer-panel>-->
  </template>
  <script>
    Polymer({
      is: 'vote-up-app',
      behaviors: [
        MyBehaviors.VoteUpAppBehavior
      ],

      properties: {
        currentSpaceId: {
          type: String
        },

        currentSpace: {
          type: Object,
          observer: "_currentSpaceObjectObserver"
        },

        spaces: {
          type: Array
        },

        topics: {
          type: Array
        },

        pageTitle: {
          type: String
        }
      },

      ready: function() {
        //this.$.document.getStoredValue('/topics').then(topics => this.allTopics = topics);
      },

      /**
       * Sign the user in
       */
      signIn: function() {
        this.$.auth.signInWithPopup();
      },

      get topicsPath() {
        return '/spaces/'+ this.currentSpaceId +'/topics/';
      },

      toEditableId: function(topicId) {
        return this.topicsPath + '/' + topicId;
      },

      get isEditable() {
        return this.online;
      },

      _getCurrentUserTopics: function(currentSpaceTopicsArray) {
        let currentUserTopics = [];
        debugger;
        // Select only topics with createdBy attr == user.id
        this.firebaseObjectToArray(this.currentSpace.topics).map(
          topic => { if (topic.value.createdBy === this.user.uid) currentUserTopics.push(topic); });

        return currentUserTopics;
      },

      // spaceDropdown value observer
      _spaceDropdownObserver: function () {
        this.currentSpaceId = this.$.spaceDropdown.selectedItem.id;
      },

      _currentSpaceObjectObserver: function (newValue, oldValue) {
        let topics;
        if (this.currentSpace.topics) {
          topics = this.firebaseObjectToArray(this.currentSpace.topics);

          // if currenUserfilter
          this.topics = (this.$.pageSelector.selected === "myTopics") ? this._getCurrentUserTopics(topics) : topics;
        }
      },

      switchPage: function() {
        switch (this.$.pageSelector.selected) {
          case "allTopics": this._currentSpaceObjectObserver(); break;
          case "myTopics": this.topics = this._getCurrentUserTopics(this.currentSpace.topics); break;
        }
      }
    });
  </script>
</dom-module>
